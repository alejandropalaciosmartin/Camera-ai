<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Esc√°ner de Tarjetas</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      background: #f5f5f5;
    }
    h2 {
      padding: 15px;
    }
    video {
      width: 100%;
      max-width: 640px;
      height: auto;
      aspect-ratio: 16/9;
      object-fit: cover;
      border: 2px solid #ccc;
      border-radius: 10px;
    }
    .buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }
    button {
      font-size: 18px;
      padding: 15px 25px;
      border: none;
      border-radius: 10px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    #status {
      margin-top: 10px;
      font-weight: bold;
    }
    canvas {
      display: none;
    }
    pre {
      text-align: left;
      max-width: 600px;
      margin: 20px auto;
      background: #eee;
      padding: 10px;
      white-space: pre-wrap;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h2>Escanea una tarjeta de visita</h2>
  <video id="video" autoplay playsinline></video>

  <div class="buttons">
    <button onclick="captureImage()">üì∏ Tomar Foto</button>
    <button onclick="switchCamera()">üîÑ Cambiar C√°mara</button>
  </div>

  <p id="status">Esperando c√°mara...</p>
  <canvas id="canvas"></canvas>
  <pre id="output"></pre>

  <script>
    let currentStream = null;
    let currentFacingMode = 'environment'; // c√°mara trasera por defecto

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const status = document.getElementById('status');
    const output = document.getElementById('output');

    async function startCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }

      const constraints = {
        video: {
          facingMode: { exact: currentFacingMode },
          width: { ideal: 1280 },
          height: { ideal: 720 },
          advanced: [{ focusMode: 'continuous' }]
        }
      };

      try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        video.srcObject = stream;
      } catch (err) {
        status.innerText = "Error al acceder a la c√°mara: " + err;
      }
    }

    function switchCamera() {
      currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
      startCamera();
    }

    async function captureImage() {
      status.innerText = "Procesando captura...";

      const ctx = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const base64Image = canvas.toDataURL('image/jpeg');

      canvas.toBlob(blob => {
        status.innerText = "Procesando OCR...";

        Tesseract.recognize(
          blob,
          'eng',
          {
            logger: m => status.innerText = `OCR: ${Math.round(m.progress * 100)}%`
          }
        ).then(({ data: { text } }) => {
          status.innerText = "Texto detectado:";
          output.innerText = text;

          const lines = text.toLowerCase().split('\n').map(l => l.trim()).filter(l => l.length > 2);

          const email = lines.find(line => line.includes('@'));
          const phone = lines.find(line => /\d{3,}/.test(line) && line.length < 20);
          const name = lines.find(line => line.length > 3 && !line.includes('@') && !/\d/.test(line));

          const jobKeywords = [
            'ceo', 'founder', 'co-founder', 'president', 'manager', 'leader', 'director',
            'affiliate', 'marketing', 'developer', 'engineer', 'executive', 'program',
            'team', 'head', 'officer', 'consultant', 'cmo', 'cto', 'cfo', 'designer', 'sales'
          ];
          const jobLine = lines.find(line => jobKeywords.some(keyword => line.includes(keyword)));

          output.innerText += "\n\nüîé Datos estructurados:";
          output.innerText += `\nüë§ Nombre: ${name || 'No detectado'}`;
          output.innerText += `\nüìß Email: ${email || 'No detectado'}`;
          output.innerText += `\nüìû Tel√©fono: ${phone || 'No detectado'}`;
          output.innerText += `\nüíº Cargo: ${jobLine || 'No detectado'}`;

          // üîÅ ENVIAR A GOOGLE SHEETS
          fetch('https://script.google.com/a/macros/getblue.io/s/AKfycbzhVpvw63x5JJ8Sv5P6LcPZR5mKlhJfGoWxH9yD4m70Xzu9qPWewoK4qUiXhE6hc9L3/exec', {
            method: 'POST',
            body: JSON.stringify({
              name: name || '',
              email: email || '',
              phone: phone || '',
              job: jobLine || '',
              imageUrl: base64Image
            }),
            headers: { 'Content-Type': 'application/json' }
          }).then(res => {
            if (res.ok) {
              status.innerText = "‚úÖ Datos enviados al Excel de Google Drive.";
            } else {
              status.innerText = "‚ö†Ô∏è Error al enviar datos al Excel.";
            }
          }).catch(() => {
            status.innerText = "‚ö†Ô∏è Error de conexi√≥n con Google Sheets.";
          });
        });
      }, 'image/jpeg');
    }

    startCamera();
  </script>
</body>
</html>
