<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Esc√°ner de Tarjetas</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      background: #f5f5f5;
    }
    h2 {
      padding: 15px;
    }
    video {
      width: 100%;
      max-width: 640px;
      height: auto;
      aspect-ratio: 16/9;
      object-fit: cover;
      border: 2px solid #ccc;
      border-radius: 10px;
    }
    .buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }
    button {
      font-size: 18px;
      padding: 15px 25px;
      border: none;
      border-radius: 10px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    #status {
      margin-top: 10px;
      font-weight: bold;
    }
    canvas {
      display: none;
    }
    pre {
      text-align: left;
      max-width: 600px;
      margin: 20px auto;
      background: #eee;
      padding: 10px;
      white-space: pre-wrap;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h2>Escanea una tarjeta de visita</h2>
  <video id="video" autoplay playsinline></video>

  <!-- Bot√≥n nuevo para enviar datos -->
<div class="buttons">
  <button onclick="captureImage()">üì∏ Tomar Foto</button>
  <button onclick="switchCamera()">üîÑ Cambiar C√°mara</button>
</div>

<button id="sendBtn" onclick="sendToExcel()" style="display:none; margin-top:10px;">üì§ Enviar datos al Excel</button>

<p id="status">Esperando c√°mara...</p>
<canvas id="canvas"></canvas>
<pre id="output"></pre>

<script>
  let currentStream = null;
  let currentFacingMode = 'environment';

  let extractedName = '';
  let extractedEmail = '';
  let extractedPhone = '';
  let extractedJob = '';
  let extractedImage = '';

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const status = document.getElementById('status');
  const output = document.getElementById('output');
  const sendBtn = document.getElementById('sendBtn');

  async function startCamera() {
    if (currentStream) currentStream.getTracks().forEach(track => track.stop());

    const constraints = {
      video: {
        facingMode: { exact: currentFacingMode },
        width: { ideal: 1280 },
        height: { ideal: 720 },
        advanced: [{ focusMode: 'continuous' }]
      }
    };

    try {
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      currentStream = stream;
      video.srcObject = stream;
    } catch (err) {
      status.innerText = "Error al acceder a la c√°mara: " + err;
    }
  }

  function switchCamera() {
    currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
    startCamera();
  }

  async function captureImage() {
    status.innerText = "Procesando captura...";

    const ctx = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    extractedImage = canvas.toDataURL('image/jpeg');

    canvas.toBlob(blob => {
      status.innerText = "Procesando OCR...";

      Tesseract.recognize(
        blob,
        'eng',
        {
          logger: m => status.innerText = `OCR: ${Math.round(m.progress * 100)}%`
        }
      ).then(({ data: { text } }) => {
        status.innerText = "Texto detectado:";
        output.innerText = text;

        const lines = text.toLowerCase().split('\n').map(l => l.trim()).filter(l => l.length > 2);

        extractedEmail = lines.find(line => line.includes('@')) || '';
        extractedPhone = lines.find(line => /\d{3,}/.test(line) && line.length < 20) || '';
        extractedName = lines.find(line => line.length > 3 && !line.includes('@') && !/\d/.test(line)) || '';

        const jobKeywords = [
          'ceo', 'founder', 'co-founder', 'president', 'manager', 'leader', 'director',
          'affiliate', 'marketing', 'developer', 'engineer', 'executive', 'program',
          'team', 'head', 'officer', 'consultant', 'cmo', 'cto', 'cfo', 'designer', 'sales'
        ];
        extractedJob = lines.find(line => jobKeywords.some(keyword => line.includes(keyword))) || '';

        output.innerText += "\n\nüîé Datos estructurados:";
        output.innerText += `\nüë§ Nombre: ${extractedName}`;
        output.innerText += `\nüìß Email: ${extractedEmail}`;
        output.innerText += `\nüìû Tel√©fono: ${extractedPhone}`;
        output.innerText += `\nüíº Cargo: ${extractedJob}`;

        sendBtn.style.display = 'inline-block';
      });
    }, 'image/jpeg');
  }

  function sendToExcel() {
    status.innerText = "üì§ Enviando datos al Excel...";

    const formData = new FormData();
    formData.append('nombre', extractedName);
    formData.append('correo', extractedEmail);
    formData.append('telefono', extractedPhone);
    formData.append('cargo', extractedJob);
    formData.append('imagen', extractedImage);

    fetch('https://script.google.com/macros/s/AKfycbx4cXkERc3ZCcw8W_SaYM92J6eekw_2DUuOxAE-849BKbahhxeSqYN6XWc8KM93e5Be/exec', {
      method: 'POST',
      body: formData
    })
    .then(res => res.ok ? res.text() : Promise.reject("Error al enviar"))
    .then(msg => {
      status.innerText = "‚úÖ Datos enviados correctamente.";
    })
    .catch(err => {
      status.innerText = "‚ö†Ô∏è No se pudo enviar: " + err;
    });
  }


  startCamera();
</script>
</body>
</html>
